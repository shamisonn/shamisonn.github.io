---
layout: default
mode: post
title: タブーサーチの話
---

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

この記事は [PMOB Advent Calendar 2018 - Adventar](https://adventar.org/calendars/3478#list-2018-12-06){:target="_blank"} 7日目の記事です。

師走。早いですね。
師走の語源って明確に存在しないって知ってました？
そうおもうとなんだか気持ち悪いですね。

はい。

アルゴリズムの話を書きます。
メタヒューリスティクスってやつですね。

いわゆる ヒューリスティクスな手法というのは、
発見的手法とも呼ばれていて立ち位置的には

「数学的に精度に保証はないけど、この手法でやると早かったり、
ある程度の解は出るよ。その証明はないけど。」
みたいなところにあるとおもってます。

よく*近似アルゴリズム* と *ヒューリスティクスなアルゴリズム* は混同されがちですが
その違いは**精度保証がなされているか** というところにあると理解してます。

- [ヒューリスティクス - Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%92%E3%83%A5%E3%83%BC%E3%83%AA%E3%82%B9%E3%83%86%E3%82%A3%E3%82%AF%E3%82%B9){:target="_blank"}

メタヒューリスティクスとはなにか。

これはつまりヒューリスティクスな手法には色々あって、
だいたいこのフレームワークにそって考えるといい感じに出やすいよ、
みたいなやつだと思ってます。

メタですね。ヒューリスティクスな手法のメタい話。

- [メタヒューリスティクス - Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%A1%E3%82%BF%E3%83%92%E3%83%A5%E3%83%BC%E3%83%AA%E3%82%B9%E3%83%86%E3%82%A3%E3%82%AF%E3%82%B9){:target="_blank"}

メタヒューリスティクスの例としては

- 遺伝的アルゴリズム
- 焼きなまし法

など多くのものが上げられますが、
その中でもタブー探索法について紹介します。

# 局所探索法(Local Search)

タブー探索法は いわゆる 局所探索法の1つです。
一応ざっくりここに書いておきます。

- [局所探索法 - Wikipedia](https://ja.wikipedia.org/wiki/%E5%B1%80%E6%89%80%E6%8E%A2%E7%B4%A2%E6%B3%95){:target="_blank"}

上記のwikipediaから引用すると、局所探索法における方法は以下のようになっています。

> 1.解を一つランダムに生成する。

> 2.現在の解の近傍の内一つをある条件で選び近傍解とする。

> 3.定義した条件を満たすなら、近傍解を現在の解と入れ換える。

> 4.終了条件を満たすまで 2. 以下を繰り返す。

以下イメージです。

![局所探索法のイメージ]({{ site.url }}/assets/posts/2018-12-07/localsearch.jpg)

タブー探索法でもこの手順を追っていきます。

なんか適当に例を上げて問題を解きたいですね。
例として「ナップサック問題」を使います。

有名な問題ですが定義はしておきます。

# ナップサック問題 (Knapsack problem)

- [ナップサック問題 - Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%8A%E3%83%83%E3%83%97%E3%82%B5%E3%83%83%E3%82%AF%E5%95%8F%E9%A1%8C){:target="_blank"}

入力として

- 品物の集合 $$I = \{1, 2, ..., N \}$$ 
- 品物の価値の集合 $$V = \{v_1, v_2, ..., v_N \}$$
- 品物の重さの集合 $$W = \{w_1, w_2, ..., w_N \}$$
- 容量 $$C$$

が与えられます。

( このとき $$i_j$$ $$(1 \leq j \leq n)$$ の 価値は $$ v_j $$ であり、
重さは $$w_j$$ と対応しています。 )

問題としては

```
「重さの合計が容量Cを超えないように品物を選び、かつ、
選んだ品物の価値の合計をできるだけ大きくするように選びたい。
どうやって選べばよいでしょうか？」
```

という問題になっています。 イメージ図です。

![ナップサック問題のイメージ]({{ site.url }}/assets/posts/2018-12-07/knapsack.jpg)

ようはドロボー問題ですね。

宝石店に盗みに入って宝石を盗まずに、受付の椅子を選ぶアホはいないでしょう、ってことです。
宝石盗んで詰め込めよ、ってことです。よくわからないですね。

数式で表せば $$x_i = \{0, 1\}$$ とし、

$$x_i$$が1のときは品物$$i$$を選ぶ、$$x_i$$が0のときは品物$$i$$を選ばない、

としたとき、以下のように表せます。

`目的関数: `$$\sum_{i \in I} v_i x_i $$

`制約条件: `$$\sum_{i \in I} w_i x_i \leq C $$

数式はわかりやすいですね。ありがとうwikipedia。

# タブー探索法 (Tabu Search)

- [タブーサーチ - Wikipedia](https://ja.wikipedia.org/wiki/%E3%82%BF%E3%83%96%E3%83%BC%E3%82%B5%E3%83%BC%E3%83%81){:target="_blank"}

局所探索法におけるネックな問題として、
局所解を最適解だと勘違いしてしまうことがあります。

![局所解と最適解のイメージ]({{ site.url }}/assets/posts/2018-12-07/localandopt.jpg)

それを「タブーリスト」という禁止事項リストを作っておくことで、
探索範囲を広くなるようにする、というアプローチになります。

今回はナップザック問題の中でも、
以下の表のような品物と容量が与えられた例を考えます。

| 品物番号 | 価値 | 重さ | 価値/重さ |
|:--------:|:----:|:----:|:---------:|
|     1    |  100 |  200 |    0.50   |
|     2    |  300 |  20  |   15.00   |
|     3    |  700 |  700 |    1.00   |
|     4    |  600 |  680 |    0.88   |
|     5    |  20  |  100 |    0.20   |

また**容量Cは 800** とします。

## 1. 初期解を生成する

初期解をランダムに生成します。

実際には完全にランダムに生成せずに、
最初の解だけは厳密アルゴリズムや、近似アルゴリズムの手法を利用する、
とかをしたりするケースも見た記憶がありますが定かではないです。

今回は$$ \{ 2, 4, 5 \}$$ を選びこれを初期解としてみます。

またこの際には

- 価値は $$300 + 600 + 20 = 920$$ 
- 重さは $$20 + 680 + 100 = 800 $$ (<- 容量ピッタリですね)

となります。

## 2. 解から近傍解を生成する

近傍解、ようはこの解の近くにいる解を生成します。
この近傍解をどう定義するのか、ということが非常に大切です。

今回はわかりやすく説明を行うために、ものすごい適当に近傍を定めます。
おそらく精度は悪いです。
(精度をよくするには貪欲法にならうといいのかな、と直感的には思います。)

近傍解を以下のように定めます。

```
「現在の解における品物をランダムに1つ選ぶ。
選んだ品物を現在の解から除いて、除く前の解に含まれていない品物を含めたもの。
なお、選んだ品物を除いても近似解が生成できてない場合は、
別の品物を選ぶこととする。」
```

長ったらしくてわかりにくいですね。例を示します。

現在の解は$$ \{ 2, 4, 5 \}$$ ですから、

**$$4$$ を選び、除くこととします。**

除かれた状態では $$\{ 2, 5 \}$$ が残りますが、

この際の重さは$$ 20 + 100 = 120 $$ なります。

よって入れる事のできる品物は 重さが$$680(= 800 - 120) $$以下の
品物になります。

入れることができるのは重さが$$100$$ の $$1$$ の品物ですね。

これを入れて近傍解としましょう。

`近傍解: ` $$\{ 1, 2, 5 \}$$

## 3. 近傍解を評価し、現在の解を更新する

近傍解を評価します。
近傍解をどう評価するか、で次に生成されれる近傍解の範囲が変わってきます。

また、今回の例だと近傍解は1つになっていますが、近傍解は複数生成されることがあります。
複数の解からどの解をどのように選ぶか、というのが肝になるわけですね。

今回の例では単純に**「品物の価値の合計」を評価値とします。**

`近傍解: ` $$\{ 1, 2, 5 \}$$ における価値は

$$ 200 + 300 + 20 = 520 $$ ですね。

前に比べてものすごく価値が下がってますね。

ですが**タブー探索法では悪い評価であっても**

**「タブーリスト」に今回行った操作 と 同じ操作がない限り**

**解を更新します。**

なので、今まで探索した中で最も良い解と、

現在の解を別々に覚えておく必要があるわけですね。

なお、解を更新する際には、

タブー探索法では「タブーリスト」にその操作を覚えておきます。

今回でいうと

```
1: remove 4, append 1
```

のようにします。
このように操作を覚えることで局所解に陥ることを防ぎます。

### 補足

ナップサック問題では評価をする際に様々な手法が考えられます。
ぱっと思いつくものとして、全く良いものとは思いませんが
「近傍の中で残り容量が少ない物を選ぶ」
という評価の仕方をしても動作はします。

適切な評価法を思いついたり考えつくことが大切ですね。

## 4.  再度近傍を生成する

近傍解を決めたので、これを新しい解とします。以下、現在の状態です。

今の解: $$\{ 1, 2, 5 \}$$ 、最も良い解: $$\{ 2, 4, 5 \}$$

タブーリスト
```
1: remove 4, append 1
```

解から近傍を求めて再度探索を進めましょう。

では、現在の解から 1 を除くこととしましょう。

重みの制限から考えられる近傍解は(計算は省略しますが)

$$4$$を加えて生成される$$\{ 2, 4, 5 \}$$ 

があります。ではこれに解を更新します。

タブーリストには新たに操作履歴を残しておきます。
```
1: remove 4, append 1
2: remove 1, append 4 <- new!
```

んん？？これって初期解に戻ってない？？
って思った人がいるかも知れません。

戻ってもいいんです。戻っても。
タブーリストに操作が記述されているからいいんです。

再度探索に戻りましょう。

---

今の解: $$\{ 2, 4, 5 \}$$ 、最も良い解: $$\{ 2, 4, 5 \}$$

タブーリスト
```
1: remove 4, append 1
2: remove 1, append 4
```

じゃあまた今度は$$4$$を再度除くことを考えましょう。
この操作を行おうとすると、タブーリストに引っかかるわけですね。

`remove 4, append 1` はタブー(禁止)ですよ、となるわけです。

初期解から同じ探索をしていない！！良いですね。

解を更新できなかったので再度選び直しです。

---

今の解: $$\{ 2, 4, 5 \}$$ 、最も良い解: $$\{ 2, 4, 5 \}$$

タブーリスト
```
1: remove 4, append 1
2: remove 1, append 4
```

では別の品物を除くことを考えましょう。$$5$$ を除くことを考えます。

そうすると$$\{ 2, 4 \}$$ の重さの合計は
$$700(=20+ 680)$$ですから $$100(=800-700)$$以下の品物を

入れることができるでしょう。

となると、入れることのできる品物は $$ 1 $$ ですかね。
そうなると解は $$ \{1, 2, 4\} $$ となり、

価値は$$200 + 300 + 600 = 1100$$ になり、

これまでの最も良い解である$$ \{2, 4, 5\} $$ を更新できました！

---

解を更新できたので、現在の解とタブーリストは以下のようになります。

現在の解: $$\{ 1, 2, 4 \}$$、最も良い解: $$\{ 1, 2, 4 \}$$
```
1: remove 4, append 1
2: remove 1, append 4
3: remove 5, appned 1
```

このように探索を行っていくわけですね。

### 補足

なおタブー探索法ではこのタブーリストに覚える操作の数は制限する必要があります。
そうでないと近傍の範囲が縮小していくだけになって、
広い範囲を探索できなくなってしまうためですね。

wikipediaではあまり大きくしないほうが良いと書いてありましたが、
結局実験的手法なので、試してみないとわかりません。

ひたすら実行しまくって実験あるのみです。

## 終了条件

探索の終了条件としては

- 全部探索し終えた
- 時間制限になった
- 規定回数探索した

などおおくの条件が考えられます。

問題の大きさや難しさに応じてパラメータを変えることが求められます。

# まとめ

ざっくり解説ですがタブー探索法を示してみました。

文字ばっかでよく読めましたね。読める人はすごいです。

私も以前使ったことがありましたが、
色々やって早くならないー勝てないーみたいなことになりがちなので、
ある程度パラメータのチューニングは時間を決めてやるのがよいですね。

あと書き終わって思いましたが、記事にすると自分の脳内の整理にもなってよいですね。
記事を書くのは良いです。


